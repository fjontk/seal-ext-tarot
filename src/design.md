# SealDice 宠物养养成插件设计书

## 1. 概述
本插件旨在为 SealDice 添加一个宠物养成系统。用户可以领养虚拟宠物，送去学校学习技能，参加每日活动（Event），并与其他玩家的宠物互动（通过Event和送礼）。

## 2. 数据结构设计

### 2.1 宠物模型 (Pet)
每个 QQ 号（UserID）绑定一只宠物。
**修改注**: 为了确保“一个QQ号在不同群也只能领养一只宠物”的原则，以及方便管理所有宠物数据进行 Rankings 或 Event 匹配，**不再使用 `$mPetData` 变量存储**。
**新方案**: 使用插件统一的 JSON 文件存储（如 `pl_pet_v1.json`），由插件自身维护读写。

```typescript
// 存储文件结构
interface StorageRoot {
  pets: { [userId: string]: Pet }; // Map: UserID -> Pet
  schoolRegistry: string[]; // 在学校的宠物 UserID 列表
  eventRegistry: string[]; // 报名参加今日 Event 的宠物 UserID 列表
  lastEventSettlement: number; // 上次 Event 结算时间戳
  lastSchoolCheck: number; // 上次学校巡逻时间戳
}

interface Pet {
  id: string; // UserID (直接作为ID)
  name: string; // 宠物名字
  species: string; // 物种 (猫, 狗, 兔子, etc.)
  
  // 状态
  hunger: number; // 饱食度 (0-100)
  hygiene: number; // 清洁度 (0-100)
  stress: number; // 压力值 (0-100, 高压力影响训练/Event成功率)
  level: number; // 等级
  location: 'home' | 'school'; // 当前位置
  lastInteractionTime: number; // 上次交互时间 (用于计算消耗)
  
  // 技能点 (0-100+)
  skills: {
    vocal: number;
    dance: number;
    rap: number;
    sellRot: number; // 卖腐
    fanService: number; // 媚粉
    life: { // 生活技能
      cooking: number;
      culture: number;
      painting: number;
      language: number;
    }
  };
  
  // 粉丝数据
  fans: {
    cpFans: number; // CP粉
    soloFans: number; // 唯粉
    toxicFans: number; // 歪屁股cp粉 (由CP粉和唯粉转化)
    extraFans: number; // 额外粉丝数 (Event奖励/惩罚，初始0)
  };

  // 当前活动
  schoolData?: {
    course: string; // 当前选修课程
    startTime: number; // 上学开始时间
  };
  
  // 每日标记
  dailyFlags: {
    giftSent: boolean; // 今日是否已送礼
    eventJoined: boolean; // 今日是否参加了 Event
    stamina: number; // 今日剩余体力 (喂食/洗澡消耗)
    nextEventBuff: number; // 外语技能带来的 Event 加成 (0 或 0.X)
  };
}

### 2.2 全局数据 (Global Data)
(已合并至 StorageRoot 结构中)

## 3. 指令系统 (Commands)

指令采用全中文格式，无需 `.pet` 前缀，便于中文用户使用。

**冲突检测与修正**:
*   为了防止群聊刷屏，养成类操作（喂食、洗澡、上学、放学、报名）**严格限制为私聊使用**。插件需检测 `ctx.isPrivate`，若在群聊中使用这些指令，需回复提示“请私聊使用此指令”。
*   `.赠送礼物` 指令可用于群聊，方便用户通过 `@` 某人或查看群成员 QQ 来赠送，但也支持私聊使用（需手动输入对方 QQ）。

| 指令 | 格式 | 权限 | 描述 |
| :--- | :--- | :--- | :--- |
| **领养** | `.领养宠物` | 公开 | 随机领养一只宠物。默认名 `<玩家>的<物种>`。如果你已有宠物则提示失败。 |
| **查看** | `.查看宠物` | 公开 | 查看宠物状态。根据宠物位置（在家/在校）显示不同信息。 |
| **改名** | `.宠物改名 <新名字>` | 公开 | 给宠物改名。 |
| **喂食** | `.喂食 <食物名>` | **私聊** | 消耗体力。增加饱食度。效果由骰子决定 (1d10+食物加成)。 |
| **洗澡** | `.洗澡` | **私聊** | 消耗体力。增加清洁度。效果由骰子决定 (1d20)。 |
| **上学** | `.送去上学 <课程名>` | **私聊** | 送宠物去学校。需选择课程。 |
| **放学** | `.接宠物` | **私聊** | 接宠物回家。结算在校期间的属性变化。 |
| **报名** | `.报名活动` | **私聊** | 报名参加今晚的活动 (Event)。 |
| **才艺** | `.才艺 <类型>` | **私聊** | (新增) 消耗体力使用生活技能。类型：烹饪、文化、绘画、外语。 |
| **送礼** | `.赠送礼物 <目标QQ> <礼物描述>` | 公开 | 给别人的宠物送礼物。每日一次。 |
| **巡逻** | `.学校巡逻` | **管理员** | (新增) 立即执行一次学校卫生检查，强制遣返清洁度不合格的宠物。 |
| **帮助** | `.宠物手册` | 公开 | 查看宠物插件的使用说明和玩法介绍。 |

### 3.1 详细交互逻辑

#### 查看宠物 (.查看宠物)
*   **在家**: 显示 饱食度、清洁度、等级、各项技能数值、粉丝数、当前体力。
*   **在学校**: 显示 "正在学习 <课程>..."。
    *   随机描述行为: "正在和隔壁的小黄狗玩耍", "正在独自舔毛", "正在对着镜子练习Wink"。
    *   显示当前饱食度和清洁度（需动态计算扣除）。

#### 送宠物上学 (.送去上学)
*   可选课程:
    *   **爱豆系**: `卖腐` (Sell Rot), `vocal`, `dance`, `rap`, `媚粉` (Fan Service).
    *   **生活系**: `烹饪`, `文化`, `绘画`, `外语`.
*   规则: 饱食度锁定 (不消耗)，但清洁度随时间下降。
*   **自动放学机制**: 每日 17:00 结算检查。若清洁度 < 0，强制遣返（标记为在家状态，并扣除少量好感或心情）。

## 4. 核心系统逻辑

### 4.1 结算与时间系统
利用 `setInterval` 设置定时任务（或懒加载结算）。

*   **每日重置 (00:00)**: 重置体力值、送礼次数、Event 报名状态。
*   **学校检查 (17:00)**:
    *   遍历在校宠物列表。
    *   计算当前清洁度 = 原清洁度 - (当前时间 - 入学时间) * 消耗率。
    *   若 < 0: 从学校列表移除，状态设为 `home`，发送通知（如无法私聊则在下次查看时提示）。
*   **Event 结算 (21:00)**:
    *   获取报名 Event 的所有宠物。
    *   **分组**: 只有1只 -> Solo; 多只 -> 随机 2-3 只一组。
    *   **表演模拟**: 结合 `vocal/dance/rap` 技能点进行判定。
    *   **结果**: 成功/大成功/失败/大失败/平平无奇。
    *   **奖励**: 更新 `extraFans` 数值（根据结果加分或减分）。
    *   记录结算日志，玩家下次查看宠物或上线时通过私聊推送结果。

### 4.2 粉丝数计算公式 (Fan Calculation)

*   **基础转换**:
    *   `CP粉` = `卖腐技能` * (系数A + 随机浮动)
    *   `唯粉` = `媚粉技能` * (系数B) + (`vocal`+`dance`+`rap`)/3 * (系数C)
*   **歪屁股cp粉转化 (Toxic Fan Conversion)**:
    *   当 `卖腐` 和 `媚粉` 等级都较高时，冲突概率增加。
    *   `歪屁股cp粉` = (`CP粉` + `唯粉`) * (转化率 based on `abs(卖腐 - 媚粉)`)
    *   *注*: 具体的“宠物品种转换率”将在领养时写入宠物数据。
*   **额外粉丝 (Event Bonus)**:
    *   初始为 0。
    *   独立于基础计算，每次参加 Event 后根据结果（成功/大成功/失败/大失败）进行加减。

### 4.3 技能评价体系
在查看属性时显示评价：
*   **ACE**: `vocal`, `dance`, `rap` 方差极小且均值 > 阈值。
*   **舞担/Vocal担/Rap担**: 对应数值显著高于其他两项。
*   **皇族/强推之耻**: (可选彩蛋) 粉丝多但技能低。

### 4.4 生活技能用途 (Life Skills Usage - 新增模块)
为了赋予生活技能实际意义，新增**“通告/创作”**系统。宠物消耗大量体力（如 40点）利用生活技能进行产出。

| 技能 | 对应行动 | 效果描述 | 游戏内收益 |
| :--- | :--- | :--- | :--- |
| **烹饪** (Cooking) | **美食直播/做饭** | 宠物自己做饭吃，或者直播做饭。 | **回复饱食度** (无需消耗食物道具)，**减少少量压力**，+ 少量粉丝。 |
| **文化** (Culture) | **写小作文/公关** | 宠物发布高情商小作文，引导粉丝舆论。 | **净化粉丝结构**：将 `toxicFans` (歪屁股cp粉) 转化为 `soloFans` 或 `cpFans`。 |
| **绘画** (Painting) | **产出饭绘** | 宠物绘制同人图/周边图。 | **大幅减少压力**，增加 CP粉。 |
| **外语** (Language) | **海外营业** | 宠物在海外社交媒体营业。 | **Event 加成**：获得 `InternationalBuff`，下一次参加 Event 的**基础成功率提升**。 |

此系统通过指令 `.才艺 <类型>` 触发。

## 5. 待补充/建议功能 (在开发中完善)
1.  **打工系统**: 赚取货币（购买食物/洗澡用品）。如果设计为纯文字互动，则不需要货币。
2.  **道具系统**: 更好的食物（加更多饱食/体力），更好的洗澡用品。
3.  **心情值**: 长期不理宠物会降低心情/好感度，影响训练效率。
4.  **互动事件**: 上学期间可能触发随机事件（被老师表扬、同学打架）。

## 6. 技术实现路线
1.  **Utils**: 编写随机数生成、时间格式化、JSON 读写工具。
2.  **Store**: 封装 `getPet(userId)`, `savePet(pet)` 函数，处理读写逻辑。
    *   注意: 如果是全局 Event，需要一个 Global JSON 文件来存储报名列表。
3.  **Command Handlers**: 逐个实现指令逻辑。
4.  **Cron**: 在 `main` 函数启动时设置定时器，处理 17:00 和 21:00 的逻辑。

## 7. 代码规范与配置化 (Code Standards & Configuration)

为了保证代码结构清晰且易于维护，所有游戏数值和常量定义必须与业务逻辑分离。

### 7.1 配置文件结构
建立独立的配置模块（如 `src/game_config.ts`），包含以下配置对象：

*   **Hashtables & Lists**:
    *   `SPECIES_LIST`: 可领养的物种列表及各自的基础转化率修正。
    *   `COURSES`: 课程列表及其对应的技能提升类型。
*   **GameConstants**:
    *   `FAN_CALCULATION`: 粉丝计算公式中的系数 (A, B, C 等)。
    *   `EVENT_REWARDS`: Event 结果对应的 `extraFans` 增减值。
    *   `SCHOOL_SETTINGS`: 消耗率、放学判定阈值等。

### 7.2 文案配置 (Text Configuration)
建立专门的文案资源文件（如 `src/game_text.ts`），所有的交互描述、Event 结果文案、系统提示均在此定义，方便修改和汉化。
*   `INTERACTIONS`: 学校/在家的随机行为描述列表。
*   `EVENT_LOGS`: 各种 Event 结果（成功/失败）对应的描述模板。
*   `CMD_RESPONSES`: 指令的回复文本。

原则上，核心逻辑代码中不应出现具体的魔法数值（Magic Numbers），全部引用配置文件的常量。这样方便后续调整平衡性。

## 8. 插件配置项 (Plugin Configuration)

为了增强插件的泛用性，使用 `seal.ext.registerConfig` 系列 API 暴露以下配置供管理员在 UI 界面调整：

### 8.1 时间与频率设置
*   **EventTime**: 每日 Event 结算的时间点 (默认 `21:00`)。
*   **SchoolCheckTime**: 每日自动执行学校巡逻（卫生检查）的时间点 (默认 `17:00`)。
*   **SchoolCheckInterval**: 学校巡逻的额外频率（单位：分钟）。
    *   若设置为 0 或负数，则仅在 `SchoolCheckTime` 执行一次。
    *   若设置为正数（如 60），则每隔 60 分钟检测一次。

### 8.2 游戏数值设置
*   **HygieneLimit**: 学校强制劝退的清洁度阈值 (默认 `0`)。
*   **EventSuccessRate**: 基础 Event 成功率修正 (默认 `0`)。

通过这些配置，管理员可以自定义“养宠节奏”，例如改成更高频的检测，或者调整活动时间以适应不同时区的玩家。

---
*设计书结束。请确认是否需要调整，若无异议将开始编写代码。*
